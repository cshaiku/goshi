#!/bin/bash
# Git pre-push hook
# Runs before pushing to remote repository

set -e

echo "üöÄ Running pre-push checks..."
echo ""

# 1. Verify we're on main or a release branch
CURRENT_BRANCH=$(git rev-parse --abbrev-ref HEAD)
echo "[1/3] Checking branch: $CURRENT_BRANCH"

if [[ "$CURRENT_BRANCH" == "main" ]] || [[ "$CURRENT_BRANCH" == release/* ]]; then
    echo "  ‚ÑπÔ∏è  Pushing to protected branch: $CURRENT_BRANCH"
fi
echo ""

# 2. Run full test suite
echo "[2/3] Running full test suite..."
if ! go test ./... 2>&1 | tail -5; then
    echo ""
    echo "‚ùå Tests failed! Push aborted."
    exit 1
fi
echo "  ‚úÖ All tests passed"
echo ""

# 3. Generate source integrity manifest
echo "[3/3] Generating source integrity manifest (.goshi/goshi.manifest)..."
SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
REPO_ROOT="$(cd "$SCRIPT_DIR/../.." && pwd)"

# Check if manifest artifacts are already staged
MANIFEST_STAGED=false
TARBALL_STAGED=false
if git diff --cached --name-only 2>/dev/null | grep -q "^\.goshi/goshi.manifest$"; then
    MANIFEST_STAGED=true
fi
if git diff --cached --name-only 2>/dev/null | grep -q "^\.goshi/goshi.source.tar.gz$"; then
    TARBALL_STAGED=true
fi

if [ "$MANIFEST_STAGED" = true ] && [ "$TARBALL_STAGED" = true ]; then
    echo "  ‚ÑπÔ∏è  .goshi reference bundle is already staged, skipping generation"
    echo "  ‚úÖ Source integrity manifest will be included in push"
elif [ ! -f "$REPO_ROOT/scripts/generate_goshi_manifest.sh" ]; then
    echo "  ‚ö†Ô∏è  Generator script not found, skipping"
else
    # Check if any .go files changed since last commit
    # This prevents regeneration loop when only manifest metadata (git hash) changes
    GO_FILES_CHANGED=$(git diff --name-only HEAD 2>/dev/null | grep '\.go$' || true)
    
    if [ -f "$REPO_ROOT/.goshi/goshi.manifest" ] && [ -f "$REPO_ROOT/.goshi/goshi.source.tar.gz" ] && [ -z "$GO_FILES_CHANGED" ]; then
        echo "  ‚ÑπÔ∏è  No Go source files changed, skipping generation"
        echo "  ‚úÖ Source integrity manifest is up to date"
    else
        if [ -n "$GO_FILES_CHANGED" ]; then
            echo "  üìù Go source files changed, regenerating..."
        fi
        bash "$REPO_ROOT/scripts/generate_goshi_manifest.sh"
        
        # Check if manifest artifacts changed
        if ! git diff --quiet -- .goshi/goshi.manifest .goshi/goshi.source.tar.gz 2>/dev/null; then
            echo ""
            echo "  ‚ö†Ô∏è  .goshi/goshi.manifest was updated"
            echo ""
            echo "  The source integrity reference bundle has changed."
            echo "  You should commit the updated artifacts:"
            echo ""
            echo "    git add .goshi/goshi.manifest .goshi/goshi.source.tar.gz"
            echo "    git commit -m 'chore: Update source integrity reference bundle'"
            echo "    git push"
            echo ""
            echo "  Or if this is intentional, you can:"
            echo "    git add .goshi/goshi.manifest .goshi/goshi.source.tar.gz"
            echo "    git commit --amend --no-edit"
            echo "    git push"
            echo ""
            exit 1
        fi
        echo "  ‚úÖ Source integrity manifest up to date"
    fi
fi
echo ""

echo "‚úÖ All pre-push checks passed!"
