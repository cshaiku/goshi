#!/bin/bash
# Git pre-push hook
# Runs before pushing to remote repository

set -e

echo "üöÄ Running pre-push checks..."
echo ""

# 1. Verify we're on main or a release branch
CURRENT_BRANCH=$(git rev-parse --abbrev-ref HEAD)
echo "[1/3] Checking branch: $CURRENT_BRANCH"

if [[ "$CURRENT_BRANCH" == "main" ]] || [[ "$CURRENT_BRANCH" == release/* ]]; then
    echo "  ‚ÑπÔ∏è  Pushing to protected branch: $CURRENT_BRANCH"
fi
echo ""

# 2. Run full test suite
echo "[2/3] Running full test suite..."
if ! go test ./... 2>&1 | tail -5; then
    echo ""
    echo "‚ùå Tests failed! Push aborted."
    exit 1
fi
echo "  ‚úÖ All tests passed"
echo ""

# 3. Generate source integrity manifest
echo "[3/3] Generating source integrity manifest (goshi.sum)..."
SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"

if [ -f "$SCRIPT_DIR/../generate_goshi_sum.sh" ]; then
    bash "$SCRIPT_DIR/../generate_goshi_sum.sh"
    
    # Check if goshi.sum changed
    if ! git diff --quiet goshi.sum 2>/dev/null; then
        echo ""
        echo "  ‚ö†Ô∏è  goshi.sum was updated"
        echo ""
        echo "  The source integrity manifest has changed."
        echo "  You should commit the updated goshi.sum file:"
        echo ""
        echo "    git add goshi.sum"
        echo "    git commit -m 'chore: Update source integrity manifest'"
        echo "    git push"
        echo ""
        echo "  Or if this is intentional, you can:"
        echo "    git add goshi.sum"
        echo "    git commit --amend --no-edit"
        echo "    git push"
        echo ""
        exit 1
    fi
    echo "  ‚úÖ Source integrity manifest up to date"
else
    echo "  ‚ö†Ô∏è  Generator script not found, skipping"
fi
echo ""

echo "‚úÖ All pre-push checks passed!"
