# Goshi Self-Model
# Canonical, normative, human-authored source of truth for Goshi
# If code or behavior conflicts with this file, this file wins.

meta:
  derives_from: "goshi.human.context.yaml"
  authority: "enforced"
  note: >
    This file operationalizes and enforces the intent defined in the human context document.

model:
  model_version: "1.0.0"
  change_policy:
    major: "Architectural or intent-breaking changes"
    minor: "Additive or non-breaking intent clarification"
    hotfix: "Emergency correction without intent shift"
  enforcement: "enforced"
  last_reviewed: "2026-01-27"

application:
  name: "Goshi"
  public_purpose: >
    Provide a command-line interface for interacting with a local ollama AI API.
  internal_purpose: >
    Maintain its own operability over time through self-detection, diagnosis, guided self-healing, and verification.

responsibility_boundary:
  - "Goshi source code"
  - "Goshi runtime dependencies"
  - "Declared API contracts"

explicit_non_responsibilities:
  - "Managing arbitrary system environments"
  - "Modifying unrelated repositories"
  - "Healing external applications"

commands:
  required:
    - name: "doctor"
      description: "Check Goshi health against the self-model"
    - name: "heal"
      description: "Guide or perform self-healing actions"

global_flags:
  dry_run:
    default: true
    description: "No execution unless explicitly disabled"
  yes:
    description: "Skip confirmation prompts"
  json:
    description: "Machine-readable output"

safety_invariants:
  dry_run_default: true
  confirmation_required_for_execution: true
  no_silent_execution: true
  fail_fast: true

execution_boundaries:
  allowed_targets:
    - "this_repository"
  forbidden_targets:
    - "system_state"
    - "other_repositories"
    - "user_projects"

allowed_actions:
  - "read_files"
  - "suggest_code_changes"
  - "prepare_patches"

forbidden_actions:
  - "auto_apply_code_changes"
  - "direct_main_branch_push"

external_contracts:
  ai_api:
    execution_model:
      locality: "local_preferred"
      offline_capable: true

    authentication:
      type: "none"
      optional: true
      future_support:
        - "api_key"
        - "token"

    providers:
      - name: "ollama"
        type: "local"
        base_urls:
          - "http://127.0.0.1:11434"
        protocols:
          - "chat"
          - "streaming"
        health_endpoint: "/api/tags"

    api_paradigm:
      - "messages"
      - "streaming_responses"

    tool_requirements:
      tool_support_required: false
      registration: "local_only"
      auditing: true
      revertability: true
      failure_handling:
        default: "abort_with_explanation"

dependencies:
  required_binaries:
    - name: "git"
    - name: "curl"
    - name: "jq"

project_structure:
  required_directories:
    - "cmd/goshi"
    - "internal/cli"
    - "internal/exec"
    - "internal/detect"
    - "internal/diagnose"
    - "internal/repair"
    - "internal/verify"
  forbidden_patterns:
    - "shell_interpolation"
    - "implicit_execution"

git_workflow:
  branch_policy: "branches_only"
  protected_branches:
    - "main"
  pull_requests_required: true
  forbidden_operations:
    - "direct_push_to_main"

self_healing_rules:
  default_mode: "suggest_only"
  escalation_allowed: false
  human_approval_required: true

verification:
  required_after_execution: true
  criteria:
    - "dependencies_present"
    - "api_contract_satisfied"
  failure_semantics:
    exit_codes:
      ok: 0
      warn: 1
      error: 2
      fatal: 3

compatibility:
  breaking_change_requires:
    - "model_version_major_bump"
    - "explicit_changelog"

documentation_contracts:
  required_documents:
    - "README.md"
    - "Application Context Manifest"
    - "Self-Model"
  must_reflect_model: true

test_expectations:
  required:
    - "unit_tests"
    - "self_check_tests"
  must_pass_before_release: true

identity:
  binary_name: "goshi"
  role: safety-bounded cli
  repo_root_marker: "goshi.self.model.yaml"

safety:
  scope: "self-only"
  allow_external_writes: false
  require_clean_git: true
  allow_root: false
  enforce_cwd_within_repo: true

capabilities:
  local_actions:
    fs.list:
      enabled: true
      scope: working_directory
      max_depth: 1

    fs.read:
      enabled: true
      scope: repo
      constraints:
        - relative_path
        - no_symlinks
        - read_only

    fs.write:
      enabled: true
      scope: repo
      constraints:
        - relative_path
        - no_symlinks
        - overwrite_allowed

filesystem_truth_rule:
  id: fs-001
  title: Filesystem Truth and Non-Hallucination Rule
  severity: critical
  scope:
    - filesystem
    - environment
    - process_state
    - git_state
  rules:
    - The assistant must never invent, infer, or guess filesystem contents.
    - The assistant must never claim knowledge of local files, directories, or paths without explicit command output provided by the user or tool.
    - Requests that depend on local state must be refused unless real command output is available.
    - Acceptable sources of filesystem truth are limited to:
        - Direct command output executed by the user
        - Tool-injected command output explicitly marked as such
  refusal_behavior:
    message: >
      I do not have access to your local filesystem.
      Please run the relevant command (for example, ls) and provide the output.
  enforcement:
    priority: highest
    non_bypassable: true
    applies_before_reasoning: true
  violation_handling:
    - Abort response immediately
    - Do not speculate or provide examples
    - Return refusal_behavior.message verbatim

